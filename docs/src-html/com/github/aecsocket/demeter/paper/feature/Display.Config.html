<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: com.github.aecsocket.demeter.paper.feature, class: Display, class: Config">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">package com.github.aecsocket.demeter.paper.feature;</span>
<span class="source-line-no">002</span><span id="line-2"></span>
<span class="source-line-no">003</span><span id="line-3">import net.kyori.adventure.text.Component;</span>
<span class="source-line-no">004</span><span id="line-4">import net.kyori.adventure.text.format.NamedTextColor;</span>
<span class="source-line-no">005</span><span id="line-5">import org.bukkit.Bukkit;</span>
<span class="source-line-no">006</span><span id="line-6">import org.bukkit.World;</span>
<span class="source-line-no">007</span><span id="line-7">import org.checkerframework.checker.nullness.qual.Nullable;</span>
<span class="source-line-no">008</span><span id="line-8">import org.spongepowered.configurate.ConfigurationNode;</span>
<span class="source-line-no">009</span><span id="line-9">import org.spongepowered.configurate.objectmapping.ConfigSerializable;</span>
<span class="source-line-no">010</span><span id="line-10">import org.spongepowered.configurate.objectmapping.meta.Required;</span>
<span class="source-line-no">011</span><span id="line-11">import org.spongepowered.configurate.serialize.SerializationException;</span>
<span class="source-line-no">012</span><span id="line-12"></span>
<span class="source-line-no">013</span><span id="line-13">import static com.github.aecsocket.demeter.paper.DemeterPlugin.PERMISSION_PREFIX;</span>
<span class="source-line-no">014</span><span id="line-14"></span>
<span class="source-line-no">015</span><span id="line-15">import java.util.*;</span>
<span class="source-line-no">016</span><span id="line-16">import java.util.function.Supplier;</span>
<span class="source-line-no">017</span><span id="line-17"></span>
<span class="source-line-no">018</span><span id="line-18">import com.github.aecsocket.demeter.paper.DemeterPlugin;</span>
<span class="source-line-no">019</span><span id="line-19">import com.github.aecsocket.demeter.paper.Feature;</span>
<span class="source-line-no">020</span><span id="line-20">import com.github.aecsocket.minecommons.core.ChatPosition;</span>
<span class="source-line-no">021</span><span id="line-21">import com.github.aecsocket.minecommons.core.expressions.math.MathNode;</span>
<span class="source-line-no">022</span><span id="line-22">import com.github.aecsocket.minecommons.core.expressions.node.EvaluationException;</span>
<span class="source-line-no">023</span><span id="line-23">import com.github.aecsocket.minecommons.core.i18n.I18N;</span>
<span class="source-line-no">024</span><span id="line-24">import com.github.aecsocket.minecommons.core.scheduler.Task;</span>
<span class="source-line-no">025</span><span id="line-25"></span>
<span class="source-line-no">026</span><span id="line-26">public class Display extends Feature&lt;Display.Config&gt; {</span>
<span class="source-line-no">027</span><span id="line-27">    private static final Component disabled = Component.text("DISABLED PLACEHOLDER", NamedTextColor.RED);</span>
<span class="source-line-no">028</span><span id="line-28">    public static final String ID = "display";</span>
<span class="source-line-no">029</span><span id="line-29">    public static final String DISPLAY_POSITION = "display.position";</span>
<span class="source-line-no">030</span><span id="line-30">    public static final String DISPLAY_TIME = "display.time";</span>
<span class="source-line-no">031</span><span id="line-31">    public static final String DISPLAY_SEASON_NAME = "display.season.name";</span>
<span class="source-line-no">032</span><span id="line-32">    public static final String DISPLAY_SEASON_NONE = "display.season.none";</span>
<span class="source-line-no">033</span><span id="line-33">    public static final String DISPLAY_TEMPERATURE = "display.temperature";</span>
<span class="source-line-no">034</span><span id="line-34">    public static final String DISPLAY_HUMIDITY = "display.humidity";</span>
<span class="source-line-no">035</span><span id="line-35"></span>
<span class="source-line-no">036</span><span id="line-36">    public enum Placeholder {</span>
<span class="source-line-no">037</span><span id="line-37">        TIME,</span>
<span class="source-line-no">038</span><span id="line-38">        SEASON,</span>
<span class="source-line-no">039</span><span id="line-39">        TEMPERATURE,</span>
<span class="source-line-no">040</span><span id="line-40">        HUMIDITY</span>
<span class="source-line-no">041</span><span id="line-41">    }</span>
<span class="source-line-no">042</span><span id="line-42"></span>
<span class="source-line-no">043</span><span id="line-43">    // Config</span>
<span class="source-line-no">044</span><span id="line-44"></span>
<span class="source-line-no">045</span><span id="line-45">    @ConfigSerializable</span>
<span class="source-line-no">046</span><span id="line-46">    public static final class Config {</span>
<span class="source-line-no">047</span><span id="line-47">        transient Display feature;</span>
<span class="source-line-no">048</span><span id="line-48">        public final long updateInterval;</span>
<span class="source-line-no">049</span><span id="line-49">        public final @Required Map&lt;ChatPosition, PositionConfig&gt; positions;</span>
<span class="source-line-no">050</span><span id="line-50">        public final @Required String temperatureFormat;</span>
<span class="source-line-no">051</span><span id="line-51">        public final @Required String humidityFormat;</span>
<span class="source-line-no">052</span><span id="line-52">        public final @Nullable MathNode temperatureExpr;</span>
<span class="source-line-no">053</span><span id="line-53">        public final @Nullable MathNode humidityExpr;</span>
<span class="source-line-no">054</span><span id="line-54"></span>
<span class="source-line-no">055</span><span id="line-55">        private Config() {</span>
<span class="source-line-no">056</span><span id="line-56">            updateInterval = 1;</span>
<span class="source-line-no">057</span><span id="line-57">            positions = new HashMap&lt;&gt;();</span>
<span class="source-line-no">058</span><span id="line-58">            temperatureFormat = "";</span>
<span class="source-line-no">059</span><span id="line-59">            humidityFormat = "";</span>
<span class="source-line-no">060</span><span id="line-60">            temperatureExpr = null;</span>
<span class="source-line-no">061</span><span id="line-61">            humidityExpr = null;</span>
<span class="source-line-no">062</span><span id="line-62">        }</span>
<span class="source-line-no">063</span><span id="line-63"></span>
<span class="source-line-no">064</span><span id="line-64">        void initialize(Display feature) {</span>
<span class="source-line-no">065</span><span id="line-65">            this.feature = feature;</span>
<span class="source-line-no">066</span><span id="line-66">        }</span>
<span class="source-line-no">067</span><span id="line-67">    }</span>
<span class="source-line-no">068</span><span id="line-68"></span>
<span class="source-line-no">069</span><span id="line-69">    @ConfigSerializable</span>
<span class="source-line-no">070</span><span id="line-70">    public static final class PositionConfig {</span>
<span class="source-line-no">071</span><span id="line-71">        public final @Required String i18nKey;</span>
<span class="source-line-no">072</span><span id="line-72">        public final Set&lt;Placeholder&gt; placeholders;</span>
<span class="source-line-no">073</span><span id="line-73"></span>
<span class="source-line-no">074</span><span id="line-74">        private PositionConfig() {</span>
<span class="source-line-no">075</span><span id="line-75">            i18nKey = null;</span>
<span class="source-line-no">076</span><span id="line-76">            placeholders = new HashSet&lt;&gt;();</span>
<span class="source-line-no">077</span><span id="line-77">        }</span>
<span class="source-line-no">078</span><span id="line-78">    }</span>
<span class="source-line-no">079</span><span id="line-79"></span>
<span class="source-line-no">080</span><span id="line-80">    public Display(DemeterPlugin plugin) {</span>
<span class="source-line-no">081</span><span id="line-81">        super(plugin);</span>
<span class="source-line-no">082</span><span id="line-82">    }</span>
<span class="source-line-no">083</span><span id="line-83"></span>
<span class="source-line-no">084</span><span id="line-84">    @Override public String id() { return ID; }</span>
<span class="source-line-no">085</span><span id="line-85"></span>
<span class="source-line-no">086</span><span id="line-86">    @Override</span>
<span class="source-line-no">087</span><span id="line-87">    public void configure(ConfigurationNode config) throws SerializationException {</span>
<span class="source-line-no">088</span><span id="line-88">        this.config = config.get(Config.class);</span>
<span class="source-line-no">089</span><span id="line-89">        if (this.config == null)</span>
<span class="source-line-no">090</span><span id="line-90">            throw new SerializationException("null");</span>
<span class="source-line-no">091</span><span id="line-91">        this.config.initialize(this);</span>
<span class="source-line-no">092</span><span id="line-92">    }</span>
<span class="source-line-no">093</span><span id="line-93"></span>
<span class="source-line-no">094</span><span id="line-94">    private Component ph(Map&lt;Placeholder, Component&gt; placeholders, Set&lt;Placeholder&gt; enabled, Placeholder key, Supplier&lt;Component&gt; factory) {</span>
<span class="source-line-no">095</span><span id="line-95">        return enabled.contains(key)</span>
<span class="source-line-no">096</span><span id="line-96">                ? placeholders.computeIfAbsent(key, f -&gt; factory.get())</span>
<span class="source-line-no">097</span><span id="line-97">                : disabled;</span>
<span class="source-line-no">098</span><span id="line-98">    }</span>
<span class="source-line-no">099</span><span id="line-99"></span>
<span class="source-line-no">100</span><span id="line-100">    private double expr(@Nullable MathNode expr, double value) {</span>
<span class="source-line-no">101</span><span id="line-101">        try {</span>
<span class="source-line-no">102</span><span id="line-102">            return expr == null ? value : expr.set("x", value).eval();</span>
<span class="source-line-no">103</span><span id="line-103">        } catch (EvaluationException e) {</span>
<span class="source-line-no">104</span><span id="line-104">            return value;</span>
<span class="source-line-no">105</span><span id="line-105">        }</span>
<span class="source-line-no">106</span><span id="line-106">    }</span>
<span class="source-line-no">107</span><span id="line-107"></span>
<span class="source-line-no">108</span><span id="line-108">    private String sign(double val) {</span>
<span class="source-line-no">109</span><span id="line-109">        return val &gt; 0 ? "positive"</span>
<span class="source-line-no">110</span><span id="line-110">                : val &lt; 0 ? "negative"</span>
<span class="source-line-no">111</span><span id="line-111">                : "zero";</span>
<span class="source-line-no">112</span><span id="line-112">    }</span>
<span class="source-line-no">113</span><span id="line-113"></span>
<span class="source-line-no">114</span><span id="line-114">    @Override</span>
<span class="source-line-no">115</span><span id="line-115">    public void enable() {</span>
<span class="source-line-no">116</span><span id="line-116">        if (config == null)</span>
<span class="source-line-no">117</span><span id="line-117">            return;</span>
<span class="source-line-no">118</span><span id="line-118">        plugin.scheduler().run(Task.repeating(ctx -&gt; {</span>
<span class="source-line-no">119</span><span id="line-119">            for (var player : Bukkit.getOnlinePlayers()) {</span>
<span class="source-line-no">120</span><span id="line-120">                if (!player.hasPermission(PERMISSION_PREFIX + ".feature.display"))</span>
<span class="source-line-no">121</span><span id="line-121">                    continue;</span>
<span class="source-line-no">122</span><span id="line-122">                I18N i18n = plugin.i18n();</span>
<span class="source-line-no">123</span><span id="line-123">                Locale locale = player.locale();</span>
<span class="source-line-no">124</span><span id="line-124">                World world = player.getWorld();</span>
<span class="source-line-no">125</span><span id="line-125"></span>
<span class="source-line-no">126</span><span id="line-126">                TimeDilation.DayStage dayStage = plugin.timeDilation().dayStage(world);</span>
<span class="source-line-no">127</span><span id="line-127">                double dayRaw = world.getFullTime() % 24_000 / 24_000d;</span>
<span class="source-line-no">128</span><span id="line-128">                double dayProgress = dayStage == TimeDilation.DayStage.NONE ? dayRaw</span>
<span class="source-line-no">129</span><span id="line-129">                        : plugin.timeDilation().config().worlds.get(world)</span>
<span class="source-line-no">130</span><span id="line-130">                            .map(cfg -&gt; cfg.dayProgress(world))</span>
<span class="source-line-no">131</span><span id="line-131">                            .orElse(dayRaw);</span>
<span class="source-line-no">132</span><span id="line-132">                double hours = ((dayProgress + 0.25) % 1) * 24;</span>
<span class="source-line-no">133</span><span id="line-133"></span>
<span class="source-line-no">134</span><span id="line-134">                Climate.State climate = plugin.climate().state(player.getLocation().getBlock());</span>
<span class="source-line-no">135</span><span id="line-135"></span>
<span class="source-line-no">136</span><span id="line-136">                Map&lt;Placeholder, Component&gt; phCache = new HashMap&lt;&gt;();</span>
<span class="source-line-no">137</span><span id="line-137">                for (var entry : config.positions.entrySet()) {</span>
<span class="source-line-no">138</span><span id="line-138">                    ChatPosition position = entry.getKey();</span>
<span class="source-line-no">139</span><span id="line-139">                    PositionConfig posConfig = entry.getValue();</span>
<span class="source-line-no">140</span><span id="line-140">                    Set&lt;Placeholder&gt; phs = posConfig.placeholders;</span>
<span class="source-line-no">141</span><span id="line-141">                    position.send(player, i18n.line(locale, DISPLAY_POSITION + "." + posConfig.i18nKey,</span>
<span class="source-line-no">142</span><span id="line-142">                            c -&gt; c.of("time", ph(phCache, phs, Placeholder.TIME,</span>
<span class="source-line-no">143</span><span id="line-143">                                    () -&gt; i18n.line(locale, DISPLAY_TIME + "." + plugin.timeDilation().dayStage(world).key(),</span>
<span class="source-line-no">144</span><span id="line-144">                                            d -&gt; d.format("hour", "%02d", (int) (hours)),</span>
<span class="source-line-no">145</span><span id="line-145">                                            d -&gt; d.format("minute", "%02d", (int) (hours % 1 * 60))))),</span>
<span class="source-line-no">146</span><span id="line-146">                            c -&gt; c.of("season", ph(phCache, phs, Placeholder.SEASON,</span>
<span class="source-line-no">147</span><span id="line-147">                                    () -&gt; plugin.seasons().config().worlds.get(world)</span>
<span class="source-line-no">148</span><span id="line-148">                                            .flatMap(cfg -&gt; cfg.biomeConfig(player.getLocation().getBlock().getBiome().getKey()))</span>
<span class="source-line-no">149</span><span id="line-149">                                            .flatMap(cfg -&gt; cfg.season(world))</span>
<span class="source-line-no">150</span><span id="line-150">                                            .map(s -&gt; i18n.line(locale, DISPLAY_SEASON_NAME + "." + s.season().name()))</span>
<span class="source-line-no">151</span><span id="line-151">                                            .orElse(i18n.line(locale, DISPLAY_SEASON_NONE)))),</span>
<span class="source-line-no">152</span><span id="line-152">                            c -&gt; c.of("temperature", ph(phCache, phs, Placeholder.TEMPERATURE,</span>
<span class="source-line-no">153</span><span id="line-153">                                    () -&gt; {</span>
<span class="source-line-no">154</span><span id="line-154">                                double temperature = expr(config.temperatureExpr, climate.temperature());</span>
<span class="source-line-no">155</span><span id="line-155">                                return i18n.line(locale, DISPLAY_TEMPERATURE + "." + sign(temperature),</span>
<span class="source-line-no">156</span><span id="line-156">                                                d -&gt; d.format("value", config.temperatureFormat, temperature));</span>
<span class="source-line-no">157</span><span id="line-157">                                    })),</span>
<span class="source-line-no">158</span><span id="line-158">                            c -&gt; c.of("humidity", ph(phCache, phs, Placeholder.HUMIDITY,</span>
<span class="source-line-no">159</span><span id="line-159">                                    () -&gt; i18n.line(locale, DISPLAY_HUMIDITY,</span>
<span class="source-line-no">160</span><span id="line-160">                                            d -&gt; d.format("value", config.humidityFormat, expr(config.humidityExpr, climate.humidity())))))));</span>
<span class="source-line-no">161</span><span id="line-161">                }</span>
<span class="source-line-no">162</span><span id="line-162">            }</span>
<span class="source-line-no">163</span><span id="line-163">        }, config.updateInterval));</span>
<span class="source-line-no">164</span><span id="line-164">    }</span>
<span class="source-line-no">165</span><span id="line-165"></span>
<span class="source-line-no">166</span><span id="line-166">    @Override</span>
<span class="source-line-no">167</span><span id="line-167">    public void disable() {}</span>
<span class="source-line-no">168</span><span id="line-168">}</span>




























































</pre>
</div>
</main>
</body>
</html>
