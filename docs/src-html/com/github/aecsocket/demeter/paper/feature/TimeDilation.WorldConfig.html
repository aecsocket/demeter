<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: com.github.aecsocket.demeter.paper.feature, class: TimeDilation, class: WorldConfig">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">package com.github.aecsocket.demeter.paper.feature;</span>
<span class="source-line-no">002</span><span id="line-2"></span>
<span class="source-line-no">003</span><span id="line-3">import it.unimi.dsi.fastutil.objects.Object2DoubleArrayMap;</span>
<span class="source-line-no">004</span><span id="line-4">import it.unimi.dsi.fastutil.objects.Object2DoubleMap;</span>
<span class="source-line-no">005</span><span id="line-5">import org.bukkit.Bukkit;</span>
<span class="source-line-no">006</span><span id="line-6">import org.bukkit.GameRule;</span>
<span class="source-line-no">007</span><span id="line-7">import org.bukkit.World;</span>
<span class="source-line-no">008</span><span id="line-8">import org.checkerframework.checker.nullness.qual.Nullable;</span>
<span class="source-line-no">009</span><span id="line-9">import org.spongepowered.configurate.ConfigurationNode;</span>
<span class="source-line-no">010</span><span id="line-10">import org.spongepowered.configurate.objectmapping.ConfigSerializable;</span>
<span class="source-line-no">011</span><span id="line-11">import org.spongepowered.configurate.objectmapping.meta.Required;</span>
<span class="source-line-no">012</span><span id="line-12">import org.spongepowered.configurate.serialize.SerializationException;</span>
<span class="source-line-no">013</span><span id="line-13">import org.spongepowered.configurate.serialize.TypeSerializer;</span>
<span class="source-line-no">014</span><span id="line-14"></span>
<span class="source-line-no">015</span><span id="line-15">import java.lang.reflect.Type;</span>
<span class="source-line-no">016</span><span id="line-16">import java.util.*;</span>
<span class="source-line-no">017</span><span id="line-17"></span>
<span class="source-line-no">018</span><span id="line-18">import com.github.aecsocket.demeter.paper.DemeterPlugin;</span>
<span class="source-line-no">019</span><span id="line-19">import com.github.aecsocket.demeter.paper.Feature;</span>
<span class="source-line-no">020</span><span id="line-20">import com.github.aecsocket.demeter.paper.WorldsConfig;</span>
<span class="source-line-no">021</span><span id="line-21">import com.github.aecsocket.minecommons.core.Duration;</span>
<span class="source-line-no">022</span><span id="line-22">import com.github.aecsocket.minecommons.core.Ticks;</span>
<span class="source-line-no">023</span><span id="line-23">import com.github.aecsocket.minecommons.core.scheduler.Task;</span>
<span class="source-line-no">024</span><span id="line-24">import com.github.aecsocket.minecommons.core.serializers.Serializers;</span>
<span class="source-line-no">025</span><span id="line-25"></span>
<span class="source-line-no">026</span><span id="line-26">public class TimeDilation extends Feature&lt;TimeDilation.Config&gt; {</span>
<span class="source-line-no">027</span><span id="line-27">    public static final String ID = "time_dilation";</span>
<span class="source-line-no">028</span><span id="line-28">    public static final int TICKS_PER_STAGE = Ticks.TPS * 60 * 10;</span>
<span class="source-line-no">029</span><span id="line-29">    public static final int TICKS_PER_DAY = TICKS_PER_STAGE * 2;</span>
<span class="source-line-no">030</span><span id="line-30">    public static final long MS_PER_STAGE = 1000 * 60 * 10;</span>
<span class="source-line-no">031</span><span id="line-31"></span>
<span class="source-line-no">032</span><span id="line-32">    // Utils</span>
<span class="source-line-no">033</span><span id="line-33"></span>
<span class="source-line-no">034</span><span id="line-34">    public record Factor(double value) {</span>
<span class="source-line-no">035</span><span id="line-35">        public static final Factor ONE = new Factor(1);</span>
<span class="source-line-no">036</span><span id="line-36"></span>
<span class="source-line-no">037</span><span id="line-37">        public Duration asDuration() {</span>
<span class="source-line-no">038</span><span id="line-38">            return Duration.duration((long) (MS_PER_STAGE / value));</span>
<span class="source-line-no">039</span><span id="line-39">        }</span>
<span class="source-line-no">040</span><span id="line-40"></span>
<span class="source-line-no">041</span><span id="line-41">        public static Factor fromDuration(Duration duration) {</span>
<span class="source-line-no">042</span><span id="line-42">            return new Factor(TICKS_PER_STAGE / (double) duration.ticks());</span>
<span class="source-line-no">043</span><span id="line-43">        }</span>
<span class="source-line-no">044</span><span id="line-44"></span>
<span class="source-line-no">045</span><span id="line-45">        public static final class Serializer implements TypeSerializer&lt;Factor&gt; {</span>
<span class="source-line-no">046</span><span id="line-46">            @Override</span>
<span class="source-line-no">047</span><span id="line-47">            public void serialize(Type type, @Nullable Factor obj, ConfigurationNode node) throws SerializationException {</span>
<span class="source-line-no">048</span><span id="line-48">                if (obj == null) node.set(null);</span>
<span class="source-line-no">049</span><span id="line-49">                else {</span>
<span class="source-line-no">050</span><span id="line-50">                    if (Double.compare(obj.value, 1) == 0)</span>
<span class="source-line-no">051</span><span id="line-51">                        node.set(obj.value);</span>
<span class="source-line-no">052</span><span id="line-52">                    else</span>
<span class="source-line-no">053</span><span id="line-53">                        node.set(obj.asDuration());</span>
<span class="source-line-no">054</span><span id="line-54">                }</span>
<span class="source-line-no">055</span><span id="line-55">            }</span>
<span class="source-line-no">056</span><span id="line-56"></span>
<span class="source-line-no">057</span><span id="line-57">            @Override</span>
<span class="source-line-no">058</span><span id="line-58">            public Factor deserialize(Type type, ConfigurationNode node) throws SerializationException {</span>
<span class="source-line-no">059</span><span id="line-59">                if (node.raw() instanceof String string &amp;&amp; string.length() &gt;= 2) {</span>
<span class="source-line-no">060</span><span id="line-60">                    char last = string.charAt(string.length() - 1);</span>
<span class="source-line-no">061</span><span id="line-61">                    switch (last) {</span>
<span class="source-line-no">062</span><span id="line-62">                        case 'x', '%' -&gt; {</span>
<span class="source-line-no">063</span><span id="line-63">                            try {</span>
<span class="source-line-no">064</span><span id="line-64">                                double factor = Double.parseDouble(string.substring(0, string.length() - 1));</span>
<span class="source-line-no">065</span><span id="line-65">                                return new Factor(last == '%' ? factor / 100 : factor);</span>
<span class="source-line-no">066</span><span id="line-66">                            } catch (NumberFormatException e) {</span>
<span class="source-line-no">067</span><span id="line-67">                                throw new SerializationException(node, type, "Could not parse factor", e);</span>
<span class="source-line-no">068</span><span id="line-68">                            }</span>
<span class="source-line-no">069</span><span id="line-69">                        }</span>
<span class="source-line-no">070</span><span id="line-70">                    }</span>
<span class="source-line-no">071</span><span id="line-71">                }</span>
<span class="source-line-no">072</span><span id="line-72">                return fromDuration(Serializers.require(node, Duration.class));</span>
<span class="source-line-no">073</span><span id="line-73">            }</span>
<span class="source-line-no">074</span><span id="line-74">        }</span>
<span class="source-line-no">075</span><span id="line-75">    }</span>
<span class="source-line-no">076</span><span id="line-76"></span>
<span class="source-line-no">077</span><span id="line-77">    public record CycleDuration(Factor day, Factor night, double ratio) {</span>
<span class="source-line-no">078</span><span id="line-78">        public static final CycleDuration ONE = new CycleDuration(Factor.ONE, Factor.ONE);</span>
<span class="source-line-no">079</span><span id="line-79"></span>
<span class="source-line-no">080</span><span id="line-80">        public CycleDuration(Factor day, Factor night) {</span>
<span class="source-line-no">081</span><span id="line-81">            this(day, night, night.value / (day.value + night.value));</span>
<span class="source-line-no">082</span><span id="line-82">        }</span>
<span class="source-line-no">083</span><span id="line-83"></span>
<span class="source-line-no">084</span><span id="line-84">        public Factor get(DayStage stage) {</span>
<span class="source-line-no">085</span><span id="line-85">            return stage == DayStage.NIGHT ? night : day;</span>
<span class="source-line-no">086</span><span id="line-86">        }</span>
<span class="source-line-no">087</span><span id="line-87"></span>
<span class="source-line-no">088</span><span id="line-88">        public String asString(Locale locale) {</span>
<span class="source-line-no">089</span><span id="line-89">            return day.asDuration().asString(locale) + " | " + night.asDuration().asString(locale);</span>
<span class="source-line-no">090</span><span id="line-90">        }</span>
<span class="source-line-no">091</span><span id="line-91"></span>
<span class="source-line-no">092</span><span id="line-92">        @Override</span>
<span class="source-line-no">093</span><span id="line-93">        public String toString() {</span>
<span class="source-line-no">094</span><span id="line-94">            return asString(Locale.ROOT);</span>
<span class="source-line-no">095</span><span id="line-95">        }</span>
<span class="source-line-no">096</span><span id="line-96"></span>
<span class="source-line-no">097</span><span id="line-97">        public static final class Serializer implements TypeSerializer&lt;CycleDuration&gt; {</span>
<span class="source-line-no">098</span><span id="line-98">            @Override</span>
<span class="source-line-no">099</span><span id="line-99">            public void serialize(Type type, @Nullable CycleDuration obj, ConfigurationNode node) throws SerializationException {</span>
<span class="source-line-no">100</span><span id="line-100">                if (obj == null) node.set(null);</span>
<span class="source-line-no">101</span><span id="line-101">                else {</span>
<span class="source-line-no">102</span><span id="line-102">                    node.setList(Factor.class, Arrays.asList(obj.day, obj.night));</span>
<span class="source-line-no">103</span><span id="line-103">                }</span>
<span class="source-line-no">104</span><span id="line-104">            }</span>
<span class="source-line-no">105</span><span id="line-105"></span>
<span class="source-line-no">106</span><span id="line-106">            @Override</span>
<span class="source-line-no">107</span><span id="line-107">            public CycleDuration deserialize(Type type, ConfigurationNode node) throws SerializationException {</span>
<span class="source-line-no">108</span><span id="line-108">                var nodes = node.childrenList();</span>
<span class="source-line-no">109</span><span id="line-109">                if (nodes.size() != 2)</span>
<span class="source-line-no">110</span><span id="line-110">                    throw new SerializationException(node, type, "Must be list of [ day duration, night duration ]");</span>
<span class="source-line-no">111</span><span id="line-111">                return new CycleDuration(</span>
<span class="source-line-no">112</span><span id="line-112">                        Serializers.require(nodes.get(0), Factor.class),</span>
<span class="source-line-no">113</span><span id="line-113">                        Serializers.require(nodes.get(1), Factor.class)</span>
<span class="source-line-no">114</span><span id="line-114">                );</span>
<span class="source-line-no">115</span><span id="line-115">            }</span>
<span class="source-line-no">116</span><span id="line-116">        }</span>
<span class="source-line-no">117</span><span id="line-117">    }</span>
<span class="source-line-no">118</span><span id="line-118"></span>
<span class="source-line-no">119</span><span id="line-119">    // Config</span>
<span class="source-line-no">120</span><span id="line-120"></span>
<span class="source-line-no">121</span><span id="line-121">    @ConfigSerializable</span>
<span class="source-line-no">122</span><span id="line-122">    public static final class Config {</span>
<span class="source-line-no">123</span><span id="line-123">        transient TimeDilation feature;</span>
<span class="source-line-no">124</span><span id="line-124">        public final @Required WorldsConfig&lt;WorldConfig&gt; worlds;</span>
<span class="source-line-no">125</span><span id="line-125"></span>
<span class="source-line-no">126</span><span id="line-126">        private Config() {</span>
<span class="source-line-no">127</span><span id="line-127">            worlds = new WorldsConfig&lt;&gt;();</span>
<span class="source-line-no">128</span><span id="line-128">        }</span>
<span class="source-line-no">129</span><span id="line-129"></span>
<span class="source-line-no">130</span><span id="line-130">        void initialize(TimeDilation feature) {</span>
<span class="source-line-no">131</span><span id="line-131">            this.feature = feature;</span>
<span class="source-line-no">132</span><span id="line-132">            for (var worldConfig : worlds.handle().values()) {</span>
<span class="source-line-no">133</span><span id="line-133">                worldConfig.initialize(this);</span>
<span class="source-line-no">134</span><span id="line-134">            }</span>
<span class="source-line-no">135</span><span id="line-135">        }</span>
<span class="source-line-no">136</span><span id="line-136">    }</span>
<span class="source-line-no">137</span><span id="line-137"></span>
<span class="source-line-no">138</span><span id="line-138">    @ConfigSerializable</span>
<span class="source-line-no">139</span><span id="line-139">    public static final class WorldConfig {</span>
<span class="source-line-no">140</span><span id="line-140">        transient Config config;</span>
<span class="source-line-no">141</span><span id="line-141">        public final CycleDuration duration;</span>
<span class="source-line-no">142</span><span id="line-142">        public final Map&lt;String, CycleDuration&gt; seasons;</span>
<span class="source-line-no">143</span><span id="line-143"></span>
<span class="source-line-no">144</span><span id="line-144">        private WorldConfig() {</span>
<span class="source-line-no">145</span><span id="line-145">            duration = CycleDuration.ONE;</span>
<span class="source-line-no">146</span><span id="line-146">            seasons = new HashMap&lt;&gt;();</span>
<span class="source-line-no">147</span><span id="line-147">        }</span>
<span class="source-line-no">148</span><span id="line-148"></span>
<span class="source-line-no">149</span><span id="line-149">        void initialize(Config config) {</span>
<span class="source-line-no">150</span><span id="line-150">            this.config = config;</span>
<span class="source-line-no">151</span><span id="line-151">        }</span>
<span class="source-line-no">152</span><span id="line-152"></span>
<span class="source-line-no">153</span><span id="line-153">        public CycleDuration appliedDuration(World world) {</span>
<span class="source-line-no">154</span><span id="line-154">            return config.feature.plugin.seasons().standardSeason(world)</span>
<span class="source-line-no">155</span><span id="line-155">                    .flatMap(season -&gt; Optional.ofNullable(seasons.get(season.name())))</span>
<span class="source-line-no">156</span><span id="line-156">                    .orElse(duration);</span>
<span class="source-line-no">157</span><span id="line-157">        }</span>
<span class="source-line-no">158</span><span id="line-158"></span>
<span class="source-line-no">159</span><span id="line-159">        public double dayProgress(World world) {</span>
<span class="source-line-no">160</span><span id="line-160">            double x = world.getFullTime() % 24_000 / 24_000d;</span>
<span class="source-line-no">161</span><span id="line-161">            // GeoGebra formula: this line passes</span>
<span class="source-line-no">162</span><span id="line-162">            //  * (0, 0)</span>
<span class="source-line-no">163</span><span id="line-163">            //  * (0.5, h)</span>
<span class="source-line-no">164</span><span id="line-164">            //  * (1, 1)</span>
<span class="source-line-no">165</span><span id="line-165">            // f(x)=If(x&lt;0.5, ((x)/(((0.5)/(h)))), (1-h)*2 (x-0.5)+h)</span>
<span class="source-line-no">166</span><span id="line-166">            // Here, h = n / (d + n), where:</span>
<span class="source-line-no">167</span><span id="line-167">            //  * d = day speed multiplier</span>
<span class="source-line-no">168</span><span id="line-168">            //  * n = night speed multiplier</span>
<span class="source-line-no">169</span><span id="line-169">            CycleDuration dur = appliedDuration(world);</span>
<span class="source-line-no">170</span><span id="line-170">            return x &lt; 0.5</span>
<span class="source-line-no">171</span><span id="line-171">                    ? x / (0.5 / dur.ratio())</span>
<span class="source-line-no">172</span><span id="line-172">                    : (1 - dur.ratio()) * 2 * (x - 0.5) + dur.ratio();</span>
<span class="source-line-no">173</span><span id="line-173">        }</span>
<span class="source-line-no">174</span><span id="line-174">    }</span>
<span class="source-line-no">175</span><span id="line-175"></span>
<span class="source-line-no">176</span><span id="line-176">    public enum DayStage {</span>
<span class="source-line-no">177</span><span id="line-177">        DAY     ("day"),</span>
<span class="source-line-no">178</span><span id="line-178">        NIGHT   ("night"),</span>
<span class="source-line-no">179</span><span id="line-179">        NONE    ("none");</span>
<span class="source-line-no">180</span><span id="line-180"></span>
<span class="source-line-no">181</span><span id="line-181">        private final String key;</span>
<span class="source-line-no">182</span><span id="line-182"></span>
<span class="source-line-no">183</span><span id="line-183">        DayStage(String key) {</span>
<span class="source-line-no">184</span><span id="line-184">            this.key = key;</span>
<span class="source-line-no">185</span><span id="line-185">        }</span>
<span class="source-line-no">186</span><span id="line-186"></span>
<span class="source-line-no">187</span><span id="line-187">        public String key() { return key; }</span>
<span class="source-line-no">188</span><span id="line-188">    }</span>
<span class="source-line-no">189</span><span id="line-189"></span>
<span class="source-line-no">190</span><span id="line-190">    private final Object2DoubleMap&lt;World&gt; elapsed = new Object2DoubleArrayMap&lt;&gt;();</span>
<span class="source-line-no">191</span><span id="line-191"></span>
<span class="source-line-no">192</span><span id="line-192">    public TimeDilation(DemeterPlugin plugin) {</span>
<span class="source-line-no">193</span><span id="line-193">        super(plugin);</span>
<span class="source-line-no">194</span><span id="line-194">    }</span>
<span class="source-line-no">195</span><span id="line-195"></span>
<span class="source-line-no">196</span><span id="line-196">    @Override public String id() { return ID; }</span>
<span class="source-line-no">197</span><span id="line-197"></span>
<span class="source-line-no">198</span><span id="line-198">    public boolean isNight(long ticks) {</span>
<span class="source-line-no">199</span><span id="line-199">        return ticks % TICKS_PER_DAY &gt; TICKS_PER_STAGE;</span>
<span class="source-line-no">200</span><span id="line-200">    }</span>
<span class="source-line-no">201</span><span id="line-201"></span>
<span class="source-line-no">202</span><span id="line-202">    public DayStage dayStage(World world) {</span>
<span class="source-line-no">203</span><span id="line-203">        return world.getEnvironment() == World.Environment.NORMAL</span>
<span class="source-line-no">204</span><span id="line-204">                ? isNight(world.getFullTime()) ? DayStage.NIGHT : DayStage.DAY</span>
<span class="source-line-no">205</span><span id="line-205">                : DayStage.NONE;</span>
<span class="source-line-no">206</span><span id="line-206">    }</span>
<span class="source-line-no">207</span><span id="line-207"></span>
<span class="source-line-no">208</span><span id="line-208">    @Override</span>
<span class="source-line-no">209</span><span id="line-209">    public void configure(ConfigurationNode config) throws SerializationException {</span>
<span class="source-line-no">210</span><span id="line-210">        this.config = config.get(Config.class);</span>
<span class="source-line-no">211</span><span id="line-211">        if (this.config == null)</span>
<span class="source-line-no">212</span><span id="line-212">            throw new SerializationException("null");</span>
<span class="source-line-no">213</span><span id="line-213">        this.config.initialize(this);</span>
<span class="source-line-no">214</span><span id="line-214">    }</span>
<span class="source-line-no">215</span><span id="line-215"></span>
<span class="source-line-no">216</span><span id="line-216">    @Override</span>
<span class="source-line-no">217</span><span id="line-217">    public void enable() {</span>
<span class="source-line-no">218</span><span id="line-218">        if (config == null)</span>
<span class="source-line-no">219</span><span id="line-219">            return;</span>
<span class="source-line-no">220</span><span id="line-220">        plugin.scheduler().run(Task.repeating(ctx -&gt; {</span>
<span class="source-line-no">221</span><span id="line-221">            for (World world : Bukkit.getWorlds()) {</span>
<span class="source-line-no">222</span><span id="line-222">                //noinspection ConstantConditions</span>
<span class="source-line-no">223</span><span id="line-223">                if (!world.getGameRuleValue(GameRule.DO_DAYLIGHT_CYCLE))</span>
<span class="source-line-no">224</span><span id="line-224">                    continue;</span>
<span class="source-line-no">225</span><span id="line-225">                config.worlds.get(world).ifPresent(worldConfig -&gt; {</span>
<span class="source-line-no">226</span><span id="line-226">                    CycleDuration duration = worldConfig.appliedDuration(world);</span>
<span class="source-line-no">227</span><span id="line-227">                    double elapsed = this.elapsed.getOrDefault(world, 0d) + duration.get(dayStage(world)).value;</span>
<span class="source-line-no">228</span><span id="line-228">                    long time = world.getFullTime() - 1;</span>
<span class="source-line-no">229</span><span id="line-229">                    while (elapsed &gt;= 1) {</span>
<span class="source-line-no">230</span><span id="line-230">                        --elapsed;</span>
<span class="source-line-no">231</span><span id="line-231">                        ++time;</span>
<span class="source-line-no">232</span><span id="line-232">                    }</span>
<span class="source-line-no">233</span><span id="line-233">                    world.setFullTime(time);</span>
<span class="source-line-no">234</span><span id="line-234">                    this.elapsed.put(world, elapsed);</span>
<span class="source-line-no">235</span><span id="line-235">                });</span>
<span class="source-line-no">236</span><span id="line-236">            }</span>
<span class="source-line-no">237</span><span id="line-237">        }, Ticks.MSPT));</span>
<span class="source-line-no">238</span><span id="line-238">    }</span>
<span class="source-line-no">239</span><span id="line-239"></span>
<span class="source-line-no">240</span><span id="line-240">    @Override</span>
<span class="source-line-no">241</span><span id="line-241">    public void disable() {}</span>
<span class="source-line-no">242</span><span id="line-242">}</span>




























































</pre>
</div>
</main>
</body>
</html>
